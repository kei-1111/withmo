name: Notify Discord

on:
  pull_request:
    types: [opened, closed, review_requested]
  issues:
    types: [opened, closed]
  issue_comment:
    types: [created]
  release:
    types: [published]
  workflow_run:
    workflows: ["CI"]          # â† å¤±æ•—ã‚’ç›£è¦–ã—ãŸã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
    types: [completed]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    if: ${{ always() }}

    steps:
      - name: Send message to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: bash
        run: |
          set -euo pipefail
          send() { curl --fail -s -H "Content-Type: application/json" -d "{\"content\":\"$1\"}" "$WEBHOOK"; }

          case "${{ github.event_name }}:${{ github.event.action }}" in
            pull_request:opened)
              send "ğŸ”” **Pull Request ä½œæˆ**\n${{ github.actor }}ã‚ˆã‚Šã€PRã€Œ${{ github.event.pull_request.title }}ã€ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚\n${{ github.event.pull_request.html_url }}"
              ;;
            pull_request:closed)
              if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
                send "âœ… **Pull Request ãƒãƒ¼ã‚¸**\n${{ github.actor }}ã‚ˆã‚Šã€PRã€Œ${{ github.event.pull_request.title }}ã€ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸã€‚\n${{ github.event.pull_request.html_url }}"
              fi
              ;;
            pull_request:review_requested)
              reviewer="${{ github.event.requested_reviewer.login || github.event.requested_team.name }}"
              send "ğŸ‘€ **ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**\n${{ github.actor }}ã‚ˆã‚Šã€${reviewer} ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼ãŒæ¥ã¾ã—ãŸã€‚\n${{ github.event.pull_request.html_url }}"
              ;;
            issues:opened)
              send "ğŸ“Œ **Issue ä½œæˆ**\n${{ github.actor }}ã‚ˆã‚Šã€Issueã€Œ${{ github.event.issue.title }}ã€ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚\n${{ github.event.issue.html_url }}"
              ;;
            issues:closed)
              send "âœ… **Issue ã‚¯ãƒ­ãƒ¼ã‚º**\n${{ github.actor }}ã‚ˆã‚Šã€Issueã€Œ${{ github.event.issue.title }}ã€ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚\n${{ github.event.issue.html_url }}"
              ;;
            issue_comment:created)
              body=$(printf %q "${{ github.event.comment.body }}")   # ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
              send "ğŸ’¬ **Issue ã‚³ãƒ¡ãƒ³ãƒˆ**\n${{ github.actor }}ã‚ˆã‚Šã‚³ãƒ¡ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚\n${body}\n${{ github.event.issue.html_url }}"
              ;;
            workflow_run:completed)
              if [[ "${{ github.event.workflow_run.conclusion }}" == "failure" ]]; then
                send "âŒ **CI/CD å¤±æ•—**\nWorkflowã€Œ${{ github.event.workflow_run.name }}ã€ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚\n${{ github.event.workflow_run.html_url }}"
              fi
              ;;
          esac
